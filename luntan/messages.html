<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿林小型论坛</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .forum-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .forum-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forum-header a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
        }

        .logout-btn {
            background: none;
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .message-list {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .message-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-item:hover {
            background-color: #f8f9fa;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        .chat-user {
            font-size: 18px;
            font-weight: 500;
        }

        .last-message {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 600px;
        }

        .message-time {
            color: #999;
            font-size: 12px;
        }

        .new-message {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .new-message h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .new-message select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .new-message button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .empty-tip {
            padding: 50px;
            text-align: center;
            color: #999;
        }

        .hide {
            display: none;
        }
    </style>
</head>
<body>
    <header class="forum-header">
        <div class="container">
            <h1>小型论坛</h1>
            <nav>
                <a href="index.html">返回首页</a>
                <button class="logout-btn" onclick="logout()">登出</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="new-message">
            <h3>发起私信</h3>
            <select id="user-select">
                <option value="">请选择聊天对象</option>
            </select>
            <button onclick="startChat()">开始聊天</button>
        </div>

        <div class="message-list" id="message-list">
            <div class="empty-tip">暂无私信会话，选择用户发起聊天吧</div>
        </div>
    </div>

    <script>
        // ========== 全局工具函数：自动补全用户编号 ==========
        function completeAllUserIds() {
            let users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            let isUpdated = false;

            function generateUniqueId(existIds) {
                let newId;
                do {
                    newId = Math.floor(Math.random() * 900000) + 100000;
                } while (existIds.includes(newId));
                return newId;
            }

            const existIds = users.filter(u => u.userId).map(u => u.userId);

            users = users.map(user => {
                if (!user.userId) {
                    user.userId = generateUniqueId(existIds);
                    existIds.push(user.userId);
                    isUpdated = true;
                }
                if (!user.nickname) user.nickname = user.username;
                if (!user.avatar) user.avatar = '';
                return user;
            });

            if (isUpdated) {
                localStorage.setItem('registeredUsers', JSON.stringify(users));
            }
        }

        // 页面加载时先补全编号
        completeAllUserIds();

        const currentUser = localStorage.getItem('username');
        if (!localStorage.getItem('isLogin') || !currentUser) {
            alert('请先登录！');
            window.location.href = 'login.html';
        }

        window.onload = function() {
            loadUserList();
            loadMessageList();
        };

        function loadUserList() {
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const userSelect = document.getElementById('user-select');
            
            users.forEach(user => {
                if (user.username !== currentUser) {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.nickname || user.username;
                    userSelect.appendChild(option);
                }
            });
        }

        function getChatId(user1, user2) {
            return [user1, user2].sort().join('-');
        }

        function startChat() {
            const targetUser = document.getElementById('user-select').value;
            if (!targetUser) {
                alert('请选择聊天对象！');
                return;
            }
            window.location.href = `chat.html?user=${targetUser}`;
        }

        function loadMessageList() {
            const messages = JSON.parse(localStorage.getItem('privateMessages') || '{}');
            const messageList = document.getElementById('message-list');
            let chatList = [];

            // 遍历所有聊天会话
            for (const chatId in messages) {
                const chat = messages[chatId];
                // 只显示当前用户参与的会话
                if (chat.users && chat.users.includes(currentUser)) {
                    // 获取聊天对象
                    const otherUser = chat.users.find(u => u !== currentUser);
                    const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                    const otherUserInfo = users.find(u => u.username === otherUser);
                    const otherNickname = otherUserInfo?.nickname || otherUser;
                    
                    // 获取最后一条消息
                    const lastMsg = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1] : {content: '暂无消息', time: 0};
                    // 格式化时间
                    const lastTime = lastMsg.time ? new Date(lastMsg.time).toLocaleString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    
                    chatList.push({
                        chatId,
                        otherUser,
                        otherNickname,
                        lastContent: lastMsg.content.length > 20 ? lastMsg.content.substring(0,20)+'...' : lastMsg.content,
                        lastTime: lastTime
                    });
                }
            }

            // 按最新消息时间排序
            chatList.sort((a, b) => {
                const timeA = messages[a.chatId].messages.length > 0 ? messages[a.chatId].messages[messages[a.chatId].messages.length - 1].time : 0;
                const timeB = messages[b.chatId].messages.length > 0 ? messages[b.chatId].messages[messages[b.chatId].messages.length - 1