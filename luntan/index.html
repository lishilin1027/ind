<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿æ—å°å‹è®ºå›</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .forum-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .forum-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .forum-header h1 {
            font-size: 24px;
        }

        .nav-list {
            display: flex;
            list-style: none;
            align-items: center;
            gap: 20px;
        }

        .nav-list li {
            margin: 0;
            padding: 0;
        }

        .nav-list a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            padding: 5px 0;
            transition: color 0.2s;
        }

        .nav-list a:hover {
            color: #cce5ff;
        }

        .forum-header .login-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .forum-header .logout-btn {
            background: none;
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .forum-header .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .post-list {
            margin-top: 20px;
        }

        .post-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .post-card h5 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .post-card h5 a {
            color: #2c3e50;
            text-decoration: none;
        }

        .post-card .post-content {
            color: #666;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .post-card .post-meta {
            color: #999;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .like-info {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ff4500;
        }

        .empty-tip {
            background-color: white;
            padding: 50px;
            text-align: center;
            border-radius: 8px;
            color: #999;
            margin-top: 20px;
        }

        .hide {
            display: none !important;
        }
    </style>
</head>
<body>
    <header class="forum-header">
        <div class="container">
            <h1>å°å‹è®ºå›</h1>
            <nav>
                <ul class="nav-list">
                    <li><a href="index.html">é¦–é¡µ</a></li>
                    <a href="new_post.html" id="publish-link" class="hide">
                    <li><a href="messages.html" id="message-link" class="hide">ç§ä¿¡</a></li>
                    <li><a href="friends.html" id="friends-link" class="hide">å¥½å‹</a></li>
                    <li><a href="profile.html" id="profile-link" class="hide">ä¸ªäººä¸­å¿ƒ</a></li>
                    <li id="user-area">
                        <a href="login.html">ç™»å½•/æ³¨å†Œ</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>æœ€æ–°å¸–å­</h2>
            <a href="new_post.html" id="publish-btn" class="btn btn-primary hide">å‘å¸ƒæ–°å¸–</a>
        </div>

        <div class="post-list" id="post-list">
            <div class="empty-tip">
                <h3>æ¬¢è¿æ¥åˆ°å°å‹è®ºå›</h3>
                <p style="margin: 10px 0;">ç™»å½•åå³å¯å‘å¸ƒå’ŒæŸ¥çœ‹å¸–å­</p>
                <a href="login.html" class="btn btn-primary">ç«‹å³ç™»å½•</a>
            </div>
        </div>
    </main>

    <script>
        // ========== å…¨å±€å·¥å…·å‡½æ•°ï¼šè‡ªåŠ¨è¡¥å…¨ç”¨æˆ·ç¼–å· ==========
        function completeAllUserIds() {
            let users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            let isUpdated = false;

            function generateUniqueId(existIds) {
                let newId;
                do {
                    newId = Math.floor(Math.random() * 900000) + 100000;
                } while (existIds.includes(newId));
                return newId;
            }

            const existIds = users.filter(u => u.userId).map(u => u.userId);

            users = users.map(user => {
                if (!user.userId) {
                    user.userId = generateUniqueId(existIds);
                    existIds.push(user.userId);
                    isUpdated = true;
                }
                if (!user.nickname) user.nickname = user.username;
                if (!user.avatar) user.avatar = '';
                return user;
            });

            if (isUpdated) {
                localStorage.setItem('registeredUsers', JSON.stringify(users));
            }
        }

        // é¡µé¢åŠ è½½æ—¶å…ˆè¡¥å…¨ç¼–å·
        completeAllUserIds();

        window.onload = function() {
            const isLogin = localStorage.getItem('isLogin') === 'true';
            const username = localStorage.getItem('username');
            const publishLink = document.getElementById('publish-link');
            const publishBtn = document.getElementById('publish-btn');
            const messageLink = document.getElementById('message-link');
            const friendsLink = document.getElementById('friends-link');
            const profileLink = document.getElementById('profile-link');
            const userArea = document.getElementById('user-area');
            const postList = document.getElementById('post-list');

            if (isLogin && username) {
                publishLink.classList.remove('hide');
                publishBtn.classList.remove('hide');
                messageLink.classList.remove('hide');
                friendsLink.classList.remove('hide');
                profileLink.classList.remove('hide');
                userArea.innerHTML = `
                    <div class="login-status">
                        <span>æ¬¢è¿, ${username}</span>
                        <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                    </div>
                `;
                loadPosts();
            } else {
                postList.innerHTML = `
                    <div class="empty-tip">
                        <h3>æ¬¢è¿æ¥åˆ°å°å‹è®ºå›</h3>
                        <p style="margin: 10px 0;">ç™»å½•åå³å¯å‘å¸ƒå’ŒæŸ¥çœ‹å¸–å­</p>
                        <a href="login.html" class="btn btn-primary">ç«‹å³ç™»å½•</a>
                    </div>
                `;
            }
        };

        function loadPosts() {
            const posts = JSON.parse(localStorage.getItem('posts') || '[]');
            const postList = document.getElementById('post-list');

            if (posts.length === 0) {
                postList.innerHTML = `
                    <div class="empty-tip">
                        <h3>æš‚æ— å¸–å­</h3>
                        <p style="margin: 10px 0;">å¿«æ¥å‘å¸ƒç¬¬ä¸€ä¸ªå¸–å­å§ï¼</p>
                        <a href="new_post.html" class="btn btn-primary">å‘å¸ƒæ–°å¸–</a>
                    </div>
                `;
                return;
            }

            let html = '';
            posts.sort((a, b) => b.time - a.time).forEach(post => {
                const date = new Date(post.time);
                const timeStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,0)}-${date.getDate().toString().padStart(2,0)} ${date.getHours().toString().padStart(2,0)}:${date.getMinutes().toString().padStart(2,0)}`;
                const likeCount = post.likes ? post.likes.length : 0;
                
                // è·å–å‘å¸–ç”¨æˆ·ä¿¡æ¯
                const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                const postUser = users.find(u => u.username === post.author);
                const userNickname = postUser?.nickname || post.author;
                const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iMTAiIHk9IjEwIiBmb250LWZhbWlseT0iTWlkZGxlIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBhbGlnbm1lbnQtYmFzZWxpbmU9Im1pZGRsZSI+5biD5Lq6PC90ZXh0Pjwvc3ZnPg==';
                const userAvatar = postUser?.avatar || defaultAvatar;
                
                html += `
                    <div class="post-card">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <img src="${userAvatar}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover;" alt="${userNickname}">
                            <span style="color: #666; font-size: 14px;">${userNickname}</span>
                        </div>
                        <h5><a href="post_detail.html?id=${post.id}">${post.title}</a></h5>
                        <div class="post-content">${post.content}</div>
                        <div class="post-meta">
                            <span>å‘å¸ƒæ—¶é—´: ${timeStr}</span>
                            <span class="like-info">
                                ğŸ‘ ${likeCount}
                            </span>
                            <span>è¯„è®º: ${post.comments ? post.comments.length : 0}</span>
                        </div>
                    </div>
                `;
            });
            postList.innerHTML = html;
        }

        function logout() {
            localStorage.removeItem('isLogin');
            localStorage.removeItem('username');
            alert('ç™»å‡ºæˆåŠŸï¼');
            window.location.reload();
        }
    </script>
    <script type="module" src="index.tsx"></script>
</body>
</html>
